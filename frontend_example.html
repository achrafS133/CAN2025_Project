<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CAN 2025 Guardian Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      h1 {
        color: #333;
        font-size: 28px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .stat-card h3 {
        color: #666;
        font-size: 14px;
        margin-bottom: 10px;
      }

      .stat-card .value {
        font-size: 32px;
        font-weight: bold;
        color: #667eea;
      }

      .main-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
      }

      .panel {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .panel h2 {
        margin-bottom: 15px;
        color: #333;
      }

      .chat-interface {
        display: flex;
        flex-direction: column;
        height: 500px;
      }

      .messages {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
      }

      .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 5px;
      }

      .message.user {
        background: #667eea;
        color: white;
        margin-left: 50px;
      }

      .message.assistant {
        background: #f0f0f0;
        margin-right: 50px;
      }

      .input-group {
        display: flex;
        gap: 10px;
      }

      input,
      select,
      button {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      input {
        flex: 1;
      }

      button {
        background: #667eea;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
      }

      button:hover {
        background: #5568d3;
      }

      .threat-list {
        max-height: 500px;
        overflow-y: auto;
      }

      .threat-item {
        padding: 15px;
        border-left: 4px solid #ff6b6b;
        background: #fff5f5;
        margin-bottom: 10px;
        border-radius: 5px;
      }

      .threat-item.medium {
        border-color: #ffa500;
        background: #fff8f0;
      }

      .threat-item.low {
        border-color: #4caf50;
        background: #f0fff0;
      }

      .threat-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
      }

      .threat-type {
        font-weight: bold;
        color: #333;
      }

      .confidence {
        color: #666;
        font-size: 12px;
      }

      .login-form {
        max-width: 400px;
        margin: 100px auto;
        background: white;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .login-form h2 {
        margin-bottom: 20px;
        color: #333;
        text-align: center;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #666;
      }

      .form-group input {
        width: 100%;
      }

      .hidden {
        display: none;
      }

      .error {
        color: #ff6b6b;
        font-size: 14px;
        margin-top: 10px;
      }

      .success {
        color: #4caf50;
        font-size: 14px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <!-- Login Form -->
    <div id="loginForm" class="login-form">
      <h2>üõ°Ô∏è CAN 2025 Guardian</h2>
      <div class="form-group">
        <label>Username</label>
        <input
          type="text"
          id="username"
          value="admin"
          placeholder="Enter username"
        />
      </div>
      <div class="form-group">
        <label>Password</label>
        <input
          type="password"
          id="password"
          value="admin123"
          placeholder="Enter password"
        />
      </div>
      <button onclick="login()" style="width: 100%">Login</button>
      <div id="loginError" class="error hidden"></div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="container hidden">
      <header>
        <h1>üõ°Ô∏è CAN 2025 Guardian Dashboard</h1>
        <p>Real-time Security Operations Center</p>
        <button onclick="logout()" style="float: right; margin-top: -30px">
          Logout
        </button>
      </header>

      <!-- Statistics Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Incidents</h3>
          <div class="value" id="totalIncidents">0</div>
        </div>
        <div class="stat-card">
          <h3>Active Alerts</h3>
          <div class="value" id="activeAlerts">0</div>
        </div>
        <div class="stat-card">
          <h3>Threats Today</h3>
          <div class="value" id="threatsToday">0</div>
        </div>
        <div class="stat-card">
          <h3>Avg Response Time</h3>
          <div class="value" id="responseTime">0</div>
          <span style="font-size: 14px; color: #666">minutes</span>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- AI Assistant -->
        <div class="panel">
          <h2>ü§ñ AI Security Assistant</h2>
          <div class="chat-interface">
            <select id="modelSelect" style="margin-bottom: 10px">
              <option value="openai">OpenAI GPT-3.5</option>
              <option value="gemini">Google Gemini Pro</option>
              <option value="claude">Claude 3 Sonnet</option>
            </select>
            <div class="messages" id="messages"></div>
            <div class="input-group">
              <input
                type="text"
                id="chatInput"
                placeholder="Ask me anything about security..."
                onkeypress="if(event.key==='Enter') sendMessage()"
              />
              <button onclick="sendMessage()">Send</button>
            </div>
          </div>
        </div>

        <!-- Recent Threats -->
        <div class="panel">
          <h2>‚ö†Ô∏è Recent Threats</h2>
          <div class="threat-list" id="threatList">
            <!-- Threats will be loaded here -->
          </div>
          <button onclick="loadThreats()" style="width: 100%; margin-top: 10px">
            Refresh
          </button>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:8888/api/v1";
      let authToken = null;

      // Login
      async function login() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        const errorDiv = document.getElementById("loginError");

        try {
          const formData = new FormData();
          formData.append("username", username);
          formData.append("password", password);

          const response = await fetch(`${API_BASE}/auth/login`, {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (response.ok) {
            authToken = data.access_token;
            document.getElementById("loginForm").classList.add("hidden");
            document.getElementById("dashboard").classList.remove("hidden");
            loadDashboard();
          } else {
            errorDiv.textContent = data.detail || "Login failed";
            errorDiv.classList.remove("hidden");
          }
        } catch (error) {
          errorDiv.textContent = "Connection error. Make sure API is running.";
          errorDiv.classList.remove("hidden");
        }
      }

      // Logout
      function logout() {
        authToken = null;
        document.getElementById("dashboard").classList.add("hidden");
        document.getElementById("loginForm").classList.remove("hidden");
      }

      // Load Dashboard Data
      async function loadDashboard() {
        await loadStats();
        await loadThreats();
      }

      // Load Statistics
      async function loadStats() {
        try {
          const response = await fetch(`${API_BASE}/analytics/dashboard`, {
            headers: {
              Authorization: `Bearer ${authToken}`,
            },
          });

          const data = await response.json();
          document.getElementById("totalIncidents").textContent =
            data.total_incidents || 0;
          document.getElementById("activeAlerts").textContent =
            data.active_alerts || 0;
          document.getElementById("threatsToday").textContent =
            data.threats_today || 0;
          document.getElementById("responseTime").textContent = (
            data.average_response_time_minutes || 0
          ).toFixed(1);
        } catch (error) {
          console.error("Failed to load stats:", error);
        }
      }

      // Load Threats
      async function loadThreats() {
        try {
          const response = await fetch(`${API_BASE}/threats/history?limit=10`, {
            headers: {
              Authorization: `Bearer ${authToken}`,
            },
          });

          const data = await response.json();
          const threatList = document.getElementById("threatList");
          threatList.innerHTML = "";

          if (data.items && data.items.length > 0) {
            data.items.forEach((threat) => {
              const severity =
                threat.confidence > 0.8
                  ? "high"
                  : threat.confidence > 0.5
                  ? "medium"
                  : "low";

              threatList.innerHTML += `
                            <div class="threat-item ${severity}">
                                <div class="threat-header">
                                    <span class="threat-type">${
                                      threat.threat_type
                                    }</span>
                                    <span class="confidence">${(
                                      threat.confidence * 100
                                    ).toFixed(1)}%</span>
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    ${threat.location || "Unknown location"} ‚Ä¢
                                    ${new Date(
                                      threat.timestamp
                                    ).toLocaleString()}
                                </div>
                            </div>
                        `;
            });
          } else {
            threatList.innerHTML =
              '<p style="text-align: center; color: #666;">No threats detected</p>';
          }
        } catch (error) {
          console.error("Failed to load threats:", error);
        }
      }

      // Send Chat Message
      async function sendMessage() {
        const input = document.getElementById("chatInput");
        const message = input.value.trim();
        if (!message) return;

        const messagesDiv = document.getElementById("messages");
        const model = document.getElementById("modelSelect").value;

        // Add user message
        messagesDiv.innerHTML += `
                <div class="message user">${message}</div>
            `;

        input.value = "";
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        try {
          const response = await fetch(`${API_BASE}/ai/chat`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              query: message,
              model: model,
            }),
          });

          const data = await response.json();

          // Add assistant message
          messagesDiv.innerHTML += `
                    <div class="message assistant">
                        ${data.response}
                        <div style="font-size: 11px; color: #999; margin-top: 5px;">
                            ${model} ‚Ä¢ ${data.tokens_used} tokens ‚Ä¢ $${(
            data.cost || 0
          ).toFixed(4)}
                        </div>
                    </div>
                `;
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        } catch (error) {
          messagesDiv.innerHTML += `
                    <div class="message assistant" style="background: #ffebee;">
                        Error: ${error.message}
                    </div>
                `;
        }
      }

      // Auto-refresh stats every 30 seconds
      setInterval(() => {
        if (authToken) {
          loadStats();
          loadThreats();
        }
      }, 30000);
    </script>
  </body>
</html>
